<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: client/js/views/MediaBrowser.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: client/js/views/MediaBrowser.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

class MediaBrowser extends View {
    constructor(params) {
        super(params);
        
        this.$element = _.div({class: 'modal fade media-browser'});

        MediaBrowser.checkMediaProvider()
        .then(() => {
            this.init();
            
            // Make sure the modal is removed when it's cancelled
            this.$element.on('hidden.bs.modal', () => {
               this.$element.remove(); 
            });

            // Show the modal
            this.$element.modal('show');
        })
        .catch(UI.errorModal);
    }

    /**
     * Gets whether the media provider exists
     *
     * @returns {Promise} Promise
     */
    static checkMediaProvider() {
        return SettingsHelper.getSettings(ProjectHelper.currentProject, ProjectHelper.currentEnvironment, 'providers')
        .then((result) => {
            if(!result || !result.media) {
                return Promise.reject(new Error('No Media provider has been set for this project. Please check providers settings.'));
            }  

            return Promise.resolve();
        }); 
    }

    /**
     * Open the upload modal
     *
     * @param {Function} onSuccess
     * @param {Function} onCancel
     * @param {String} replaceId
     */
    static uploadModal(onSuccess, onCancel, replaceId) {
        MediaBrowser.checkMediaProvider()
        .then(() => {
            let navbar = ViewHelper.get('NavbarMain');

            // Event: Change file
            function onChangeFile() {
                let input = $(this);
                let numFiles = this.files ? this.files.length : 1;
               
                // In the case of a single file selected 
                if(numFiles == 1) {
                    let file = this.files[0];

                    let isImage =
                        file.type == 'image/png' ||
                        file.type == 'image/jpeg' ||
                        file.type == 'image/gif';

                    let isVideo =
                        file.type == 'video/mpeg' ||
                        file.type == 'video/mp4' ||
                        file.type == 'video/quicktime' ||
                        file.type == 'video/x-matroska';

                    if(isImage) {
                        let reader = new FileReader();
                        
                        uploadModal.$element.find('.spinner-container').toggleClass('hidden', false);

                        reader.onload = function(e) {
                            uploadModal.$element.find('.media-preview').html(
                                _.img({src: e.target.result})
                            );


                            uploadModal.$element.find('.spinner-container').toggleClass('hidden', true);
                        }
                        
                        reader.readAsDataURL(file);
                    }
                            
                    if(isVideo) {
                        uploadModal.$element.find('.media-preview').html(
                            _.video({src: window.URL.createObjectURL(file), controls: 'controls'})
                        );
                    }

                    debug.log('Previewing data of file type ' + file.type + '...', navbar);
                
                // Multiple files selected
                } else if(numFiles > 1) {
                    uploadModal.$element.find('.media-preview').html(
                        '(Multiple files selected)'
                    );
                
                // No files selected
                } else if(numFiles == 0) {
                    uploadModal.$element.find('.media-preview').html(
                        '(No files selected)'
                    );
                }
            }
           
            // Event: Click upload
            function onClickUpload() {
                uploadModal.$element.find('form').submit();

                return false;
            }

            // Event: Submit
            function onSubmit(e) {
                e.preventDefault();

                uploadModal.$element.find('.spinner-container').toggleClass('hidden', false);

                let apiPath = 'media/' + (replaceId ? 'replace/' + replaceId : 'new');

                $.ajax({
                    url: apiUrl(apiPath),
                    type: 'POST',
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    success: (ids) => {
                        reloadResource('media')
                        .then(() => {
                            uploadModal.$element.find('.spinner-container').toggleClass('hidden', true);

                            navbar.reload();

                            if(onSuccess) {
                                onSuccess(ids || []);
                            }
                            
                            uploadModal.hide();
                        });
                    },
                    error: errorModal
                });
            }

            // Render the upload modal
            let uploadModal = new MessageModal({
                model: {
                    class: 'modal-upload-media',
                    title: 'Upload a file',
                    body: [
                        _.div({class: 'spinner-container hidden'},
                            _.span({class: 'spinner fa fa-refresh'})
                        ),
                        _.div({class: 'media-preview'}),
                        _.form({class: 'form-control'},
                            _.input({type: 'file', name: 'media', multiple: replaceId ? false : true})
                                .change(onChangeFile)
                        ).submit(onSubmit)
                    ]
                },
                buttons: [
                    {
                        label: 'Cancel',
                        class: 'btn-default',
                        callback: onCancel
                    },
                    {
                        label: 'Upload',
                        class: 'btn-primary',
                        callback: onClickUpload
                    }
                ]
            });

            // Event: Close modal
            uploadModal.on('close', () => {
                if(onCancel) {
                    onCancel();
                } 
            });
        })
        .catch(UI.errorModal);
    }

    /**
     * Event: Search media
     */
    onSearchMedia() {
        let query = (this.$element.find('.input-search-media').val() || '').toLowerCase();

        this.$element.find('.thumbnail').each(function(i) {
            let isMatch = (!query || ($(this).attr('data-name') || '').toLowerCase().indexOf(query) > -1);     

            $(this).toggleClass('hidden', !isMatch);
        });       
    }

    /** 
     * Event: Click OK
     */
    onClickOK() {
        this.value = this.$element.find('.thumbnail.active').attr('data-id');

        if(this.value) {
            this.trigger('select', this.value);
        }

        this.$element.modal('hide');
    }
    
    /** 
     * Event: Click cancel
     */
    onClickCancel() {
        this.$element.modal('hide');
    }

    render() {
        // Render the modal
        let $folders = [];

        _.append(this.$element.empty(),
            _.div({class: 'modal-dialog'},
                _.div({class: 'modal-content'},
                    _.div({class: 'modal-header'},
                        _.div({class: 'input-group'}, 
                            _.input({class: 'form-control input-search-media', placeholder: 'Search media'})
                                .on('change keyup paste', () => {
                                    this.onSearchMedia();
                                }),
                            _.div({class: 'input-group-btn'},
                                _.button({class: 'btn btn-primary'},
                                    'Upload file'
                                ).click(() => {
                                    this.$element.toggleClass('disabled', true);

                                    MediaBrowser.uploadModal(
                                        (id) => {
                                            this.$element.toggleClass('disabled', false);

                                            this.value = id;

                                            this.render();
                                        },
                                        () => {
                                            this.$element.toggleClass('disabled', false);
                                        }
                                    );
                                })
                            )
                        )
                    ),
                    _.div({class: 'modal-body'},
                        _.div({class: 'thumbnail-container'},
                            // Append all files
                            _.each(resources.media, (i, media) => {
                                media = new Media(media);

                                let $media = _.button(
                                    {
                                        class: 'thumbnail raised',
                                        'data-id': media.id,
                                        'data-name': media.name,
                                    },
                                    _.if(media.isVideo(),
                                        _.video({src: '/media/' + ProjectHelper.currentProject + '/' + ProjectHelper.currentEnvironment + '/' + media.id})
                                    ),
                                    _.if(media.isImage(),
                                        _.img({src: '/media/' + ProjectHelper.currentProject + '/' + ProjectHelper.currentEnvironment + '/' + media.id})
                                    ),
                                    _.label(media.name)  
                                ).click(() => {
                                    this.$element.find('.thumbnail').toggleClass('active', false);
                                    $media.toggleClass('active', true);
                                });
                                
                                if(media.folder &amp;&amp; media.folder != '/') {
                                    let $folder = $folders[media.folder];

                                    if(!$folder) {
                                        $folder = _.div({class: 'folder', 'data-path': media.folder},
                                            _.div({class: 'folder-heading'},
                                                _.h4({},
                                                    _.span({class: 'fa fa-folder'}),
                                                    media.folder
                                                )
                                            ),
                                            _.div({class: 'folder-items'})
                                        );

                                        $folders[media.folder] = $folder;
                                    }

                                    // Wait 1 CPU cycle before appending to folders
                                    setTimeout(() =>{ 
                                        $folder.find('.folder-items').append($media);
                                    }, 1);
                                }

                                return $media;
                            }),

                            // Append all folders
                            _.each(Object.keys($folders).sort(), (i, path) => {
                                return $folders[path];
                            })
                        )
                    ),
                    _.div({class: 'modal-footer'},
                        _.button({class: 'btn btn-default'},
                            'Cancel'
                        ).click(() => {
                            this.onClickCancel();
                        }),
                        _.button({class: 'btn btn-primary'},
                            'OK'
                        ).click(() => {
                            this.onClickOK();
                        })
                    )
                )
            )
        );

        // Mark the selected media as active
        this.$element.find('.thumbnail[data-id="' + this.value + '"]').toggleClass('active', true);
    }
}

module.exports = MediaBrowser;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ApiController.html">ApiController</a></li><li><a href="AppHelper.html">AppHelper</a></li><li><a href="BackupHelper.html">BackupHelper</a></li><li><a href="BooleanEditor.html">BooleanEditor</a></li><li><a href="Connection.html">Connection</a></li><li><a href="ConnectionController.html">ConnectionController</a></li><li><a href="Content.html">Content</a></li><li><a href="ContentController.html">ContentController</a></li><li><a href="ContentReferenceEditor.html">ContentReferenceEditor</a></li><li><a href="ContentSchema.html">ContentSchema</a></li><li><a href="ContentSchemaReferenceEditor.html">ContentSchemaReferenceEditor</a></li><li><a href="Controller.html">Controller</a></li><li><a href="DateEditor.html">DateEditor</a></li><li><a href="DropdownEditor.html">DropdownEditor</a></li><li><a href="Entity.html">Entity</a></li><li><a href="FieldSchema.html">FieldSchema</a></li><li><a href="Form.html">Form</a></li><li><a href="FormEditor.html">FormEditor</a></li><li><a href="FormHelper.html">FormHelper</a></li><li><a href="InfoEditor.html">InfoEditor</a></li><li><a href="JSONEditor.html">JSONEditor</a></li><li><a href="LanguageEditor.html">LanguageEditor</a></li><li><a href="Media.html">Media</a></li><li><a href="MediaReferenceEditor.html">MediaReferenceEditor</a></li><li><a href="MessageModal.html">MessageModal</a></li><li><a href="MongoHelper.html">MongoHelper</a></li><li><a href="NavbarMain.html">NavbarMain</a></li><li><a href="NumberEditor.html">NumberEditor</a></li><li><a href="ProjectEditor.html">ProjectEditor</a></li><li><a href="ProjectHelper.html">ProjectHelper</a></li><li><a href="ProvidersSettings.html">ProvidersSettings</a></li><li><a href="RequestHelper.html">RequestHelper</a></li><li><a href="ResourceReferenceEditor.html">ResourceReferenceEditor</a></li><li><a href="RichTextEditor.html">RichTextEditor</a></li><li><a href="ScheduleController.html">ScheduleController</a></li><li><a href="ScheduleHelper.html">ScheduleHelper</a></li><li><a href="Schema.html">Schema</a></li><li><a href="SchemaController.html">SchemaController</a></li><li><a href="SchemaEditor.html">SchemaEditor</a></li><li><a href="SchemaHelper.html">SchemaHelper</a></li><li><a href="StringEditor.html">StringEditor</a></li><li><a href="StructEditor.html">StructEditor</a></li><li><a href="SyncEditor.html">SyncEditor</a></li><li><a href="SyncHelper.html">SyncHelper</a></li><li><a href="TagsEditor.html">TagsEditor</a></li><li><a href="Task.html">Task</a></li><li><a href="Template.html">Template</a></li><li><a href="TemplateEditor.html">TemplateEditor</a></li><li><a href="TemplateReferenceEditor.html">TemplateReferenceEditor</a></li><li><a href="UpdateHelper.html">UpdateHelper</a></li><li><a href="UrlEditor.html">UrlEditor</a></li><li><a href="UserHelper.html">UserHelper</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon May 29 2017 21:20:48 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
