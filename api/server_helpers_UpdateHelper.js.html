<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server/helpers/UpdateHelper.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server/helpers/UpdateHelper.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

// Libs
let spawn = require('child_process').spawn;
let exec = require('child_process').exec;

/**
 * The helper class for system updates
 */
class UpdateHelper {
    /**
     * Check for updates
     *
     * @returns {Promise} Status info
     */
    static check() {
        return new Promise((resolve, reject) => {
            let resolveObj = {
                behind: false,
                amount: 0,
                branch: 'stable',
                comment: ''
            };
            
            debug.log('Checking for updates...', this);

            function checkOutput(data) {
                let behindMatches = data.match(/Your branch is behind '(.+)' by (\d+) commit/);
                let upToDateMatches = data.match(/Your branch is up-to-date with '(.+)'/);
                let messageMatches = data.match(/[a-z0-9]{40} (.+)/);

                if(behindMatches &amp;&amp; behindMatches.length > 1) {
                    resolveObj.behind = true;
                    resolveObj.branch = behindMatches[1].replace('origin/', '');
                    resolveObj.amount = behindMatches[2];
                }
                
                if(upToDateMatches &amp;&amp; upToDateMatches.length > 1) {
                    resolveObj.branch = upToDateMatches[1].replace('origin/', '');
                }

                if(messageMatches &amp;&amp; messageMatches.length > 1) {
                    resolveObj.comment = messageMatches[1];
                }
            }
            
            let git = exec('git fetch &amp;&amp; git status &amp;&amp; git log origin -1 --format=oneline', {
                cwd: appRoot
            });

            git.stdout.on('data', (data) => {
                checkOutput(data);
                debug.log(data, this, 3);
            });

            git.stderr.on('data', (data) => {
                checkOutput(data);
                debug.log(data, this, 3);
            });
            
            git.on('exit', (code) => {
                if(code == 0 || code == '0') {
                    debug.log('Done checking for updates', this);
                    resolve(resolveObj);
                } else {
                    if(resolveObj.behind &amp;&amp; resolveObj.amount > 0) {
                        debug.log('Done checking for updates, but couldn\'t get last commit message', this);
                        resolve(resolveObj);
                    
                    } else {
                        debug.log('Checking for updates failed', this);
                        reject(new Error('Checking for updates failed. Please run "git fetch &amp;&amp; git status &amp;&amp; git log origin -1 --format=oneline" on the server to check if it runs correctly.'));
                    }
                }
            });
        });
    }
    
    /**
     * Perform update
     *
     * @returns {Promise} Status info
     */
    static update() {
        return new Promise((resolve, reject) => {
            debug.log('Updating HashBrown...', this);
            
            let git = exec('git pull', {
                cwd: appRoot
            });

            git.stdout.on('data', (data) => {
                debug.log(data, this, 3);
            });

            git.stderr.on('data', (data) => {
                debug.log(data, this, 3);
            });
            
            git.on('exit', (code) => {
                if(code == 0 || code == '0') {
                    debug.log('Update successful', this);
                    resolve();
                } else {
                    debug.log('Update failed', this);
                    reject(new Error('git exited with status code ' + code));
                }
            });
        })

        // Install dependencies
        .then(() => {
            return new Promise((resolve, reject) => {
                debug.log('Installing dependencies...', this);
                
                let npm = exec('npm install --production', {
                    cwd: appRoot
                });

                npm.stdout.on('data', (data) => {
                    debug.log(data, this, 3);
                });

                npm.stderr.on('data', (data) => {
                    debug.log(data, this, 3);
                });
                
                npm.on('exit', (code) => {
                    if(code == 0 || code == '0') {
                        debug.log('Install successful', this);
                        resolve();
                    } else {
                        debug.log('Update failed', this);
                        reject(new Error('npm exited with status code ' + code));
                    }
                });
            });
        });
    }
}

module.exports = UpdateHelper;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ApiController.html">ApiController</a></li><li><a href="AppHelper.html">AppHelper</a></li><li><a href="BackupHelper.html">BackupHelper</a></li><li><a href="BooleanEditor.html">BooleanEditor</a></li><li><a href="Connection.html">Connection</a></li><li><a href="ConnectionController.html">ConnectionController</a></li><li><a href="Content.html">Content</a></li><li><a href="ContentController.html">ContentController</a></li><li><a href="ContentReferenceEditor.html">ContentReferenceEditor</a></li><li><a href="ContentSchema.html">ContentSchema</a></li><li><a href="ContentSchemaReferenceEditor.html">ContentSchemaReferenceEditor</a></li><li><a href="Controller.html">Controller</a></li><li><a href="DateEditor.html">DateEditor</a></li><li><a href="DropdownEditor.html">DropdownEditor</a></li><li><a href="Entity.html">Entity</a></li><li><a href="FieldSchema.html">FieldSchema</a></li><li><a href="Form.html">Form</a></li><li><a href="FormEditor.html">FormEditor</a></li><li><a href="FormHelper.html">FormHelper</a></li><li><a href="InfoEditor.html">InfoEditor</a></li><li><a href="JSONEditor.html">JSONEditor</a></li><li><a href="LanguageEditor.html">LanguageEditor</a></li><li><a href="Media.html">Media</a></li><li><a href="MediaReferenceEditor.html">MediaReferenceEditor</a></li><li><a href="MessageModal.html">MessageModal</a></li><li><a href="MongoHelper.html">MongoHelper</a></li><li><a href="NavbarMain.html">NavbarMain</a></li><li><a href="NumberEditor.html">NumberEditor</a></li><li><a href="ProjectEditor.html">ProjectEditor</a></li><li><a href="ProjectHelper.html">ProjectHelper</a></li><li><a href="ProvidersSettings.html">ProvidersSettings</a></li><li><a href="RequestHelper.html">RequestHelper</a></li><li><a href="ResourceReferenceEditor.html">ResourceReferenceEditor</a></li><li><a href="RichTextEditor.html">RichTextEditor</a></li><li><a href="ScheduleController.html">ScheduleController</a></li><li><a href="ScheduleHelper.html">ScheduleHelper</a></li><li><a href="Schema.html">Schema</a></li><li><a href="SchemaController.html">SchemaController</a></li><li><a href="SchemaEditor.html">SchemaEditor</a></li><li><a href="SchemaHelper.html">SchemaHelper</a></li><li><a href="StringEditor.html">StringEditor</a></li><li><a href="StructEditor.html">StructEditor</a></li><li><a href="SyncEditor.html">SyncEditor</a></li><li><a href="SyncHelper.html">SyncHelper</a></li><li><a href="TagsEditor.html">TagsEditor</a></li><li><a href="Task.html">Task</a></li><li><a href="Template.html">Template</a></li><li><a href="TemplateEditor.html">TemplateEditor</a></li><li><a href="TemplateReferenceEditor.html">TemplateReferenceEditor</a></li><li><a href="UpdateHelper.html">UpdateHelper</a></li><li><a href="UrlEditor.html">UrlEditor</a></li><li><a href="UserHelper.html">UserHelper</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon May 29 2017 21:20:48 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
