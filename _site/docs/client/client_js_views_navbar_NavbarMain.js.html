<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: client/js/views/navbar/NavbarMain.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: client/js/views/navbar/NavbarMain.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

// Views
let MessageModal = require('../MessageModal');

// Models
let Content = require('../../../../common/models/Content');

// Panes
let ConnectionPane = require('./ConnectionPane');
let ContentPane = require('./ContentPane');
let FormsPane = require('./FormsPane');
let MediaPane = require('./MediaPane');
let SchemaPane = require('./SchemaPane');

/**
 * The main navbar
 */
class NavbarMain extends View {
    constructor(params) {
        super(params);

        this.connectionPane = ConnectionPane;
        this.contentPane = ContentPane;
        this.formsPane = FormsPane;
        this.mediaPane = MediaPane;
        this.schemaPane = SchemaPane;

        this.$element = _.nav({class: 'navbar-main'},
            _.div({class: 'tab-buttons'}),
            _.div({class: 'tab-panes'})
        );
        
        $('.navspace').html(this.$element);

        this.fetch();
    }
    
    /**
     * Event: Error was returned
     */
    onError(err) {
        new MessageModal({
            model: {
                title: 'Error',
                body: err
            }
        });
    }
    
    /**
     * Event: Click copy item id
     */
    onClickCopyItemId() {
        let id = $('.context-menu-target-element').data('id');

        copyToClipboard(id);
    }

    /**
     * Fetches pane information and renders it
     *
     * @param {Object} params
     */
    renderPane(params) {
        let view = this;
        let $icon = params.$icon;
       
        if(!$icon) {        
            $icon = _.span({class: 'fa fa-' + params.icon});
        }

        let $button = _.button({'data-route': params.route},
            _.div({class: 'pane-icon'},
                $icon
            ),
            _.div({class: 'pane-text'},
                _.span({class: 'pane-label'}, params.label),
                params.sublabel ? _.span({class: 'pane-sublabel'}, params.sublabel) : ''
            )
        ).click(function() {
            let $currentTab = view.$element.find('.pane-container.active');

            if(params.route == $currentTab.attr('data-route')) {
                location.hash = params.route;
            
            } else {
                view.showTab(params.route);
            
            }
        });
        
        let $pane = _.div({class: 'pane'});

        let items = params.items;
        let sortingQueue = [];

        // Attach item context menu
        if(params.paneContextMenu) {
            $pane.exocontext(params.paneContextMenu);
        }

        // Items
        $pane.append(
            _.each(items, function(i, item) {
                let id = item.id || i;

                // Get item name
                let name = '';

                if(item.properties &amp;&amp; item.properties.title) {
                    if(typeof item.properties.title === 'string') {
                        name = item.properties.title;
                    } else if(typeof item.properties.title === 'object' &amp;&amp; item.properties.title[window.language]) {
                        name = item.properties.title[window.language];
                    } else {
                        name = '(error)';
                    }
                
                } else if(typeof item.title === 'string') {
                    name = item.title;

                } else if(typeof item.name === 'string') {
                    name = item.name;

                } else {
                    name = id;

                }

                let routingPath = item.shortPath || item.path || id;
                let queueItem = {};
                let icon = item.icon;
                let $icon;

                // Truncate long names
                if(name.length > 30) {
                    name = name.substring(0, 30) + '...';
                }

                // If this item has a schema id, fetch the appropriate icon
                if(item.schemaId) {
                    icon = resources.schemas[item.schemaId].icon;
                }

                if(icon) {
                    $icon = _.span({class: 'fa fa-' + icon});
                }

                // Item element
                let $element = _.div({
                    class: 'pane-item-container',
                    'data-routing-path': routingPath
                },
                    _.a({
                        'data-id': id,
                        'data-name': name,
                        href: '#' + params.route + routingPath,
                        class: 'pane-item'
                    },
                        $icon,
                        _.span(name)
                    ),
                    _.div({class: 'children'})
                );

                // Attach item context menu
                if(params.itemContextMenu) {
                    $element.find('a').exocontext(params.itemContextMenu);
                }
                
                // Add element to queue item
                queueItem.$element = $element;

                // Use specific sorting behaviours
                if(params.sort) {
                    params.sort(item, queueItem);
                }

                // Add queue item to sorting queue
                sortingQueue.push(queueItem);

                // Add drag/drop event
                if(typeof params.onEndDrag === 'function') {
                    $element.exodragdrop({
                        lockX: true,
                        onEndDrag: params.onEndDrag
                    });
                }

                return $element;
            })
        );

        // Place items into hierarchy
        for(let queueItem of sortingQueue) {
            if(queueItem.parentDirAttr) { 
                // Find parent item
                let parentDirAttrKey = Object.keys(queueItem.parentDirAttr)[0];
                let parentDirAttrValue = queueItem.parentDirAttr[parentDirAttrKey];
                let parentDirSelector = '.pane-item-container[' + parentDirAttrKey + '="' + parentDirAttrValue + '"]';
                let $parentDir = $pane.find(parentDirSelector);
          
                // If parent element already exists, just append the queue item element
                if($parentDir.length > 0) {
                    $parentDir.children('.children').append(queueItem.$element);
                
                // If not, create parent elements if specified
                } else if(queueItem.createDir) {
                    let dirNames = parentDirAttrValue.split('/').filter((item) => { return item != ''; });
                    let finalDirName = '/';

                    for(let i in dirNames) {
                        let dirName = dirNames[i];

                        let prevFinalDirName = finalDirName;
                        finalDirName += dirName + '/';

                        let $dir = $pane.find('[' + parentDirAttrKey + '="' + finalDirName + '"]');

                        if($dir.length &lt; 1) {
                            $dir = _.div({class: 'pane-item-container'},
                                _.a({
                                    class: 'pane-item'
                                },
                                    _.span({class: 'fa fa-folder'}),
                                    _.span(dirName)
                                ),
                                _.div({class: 'children'})
                            );
                            
                            $dir.attr(parentDirAttrKey, finalDirName);
                   
                            // Append to previous dir 
                            let $prevDir = $pane.find('[' + parentDirAttrKey + '="' + prevFinalDirName + '"]');
                            
                            if($prevDir.length > 0) {
                                $prevDir.children('.children').append($dir);

                            // If no previous dir was found, append directly to pane
                            } else {
                                $pane.append($dir); 
                            }
                        }
                       
                        // Attach item context menu
                        if(params.dirContextMenu) {
                            $dir.exocontext(params.dirContextMenu);
                        }
                        
                        // Only append the queue item to the final parent element
                        if(i >= dirNames.length - 1) {
                            $parentDir = $dir;
                        } 
                    }

                    $parentDir.children('.children').append(queueItem.$element);
                }

            }
        }

        let $paneContainer = _.div({class: 'pane-container', 'data-route': params.route},
            $pane
        );

        // Add expand/collapse buttons to items if needed
        $paneContainer.find('.pane-item-container').each((i, element) => {
            let $paneItemContainer = $(element);
            let $paneItem = $paneItemContainer.children('.pane-item');;
            let $children = $paneItemContainer.children('.children');
            
            if($children.children().length > 0) {
                let $childrenToggle = _.button({class: 'btn-children-toggle'},
                    _.span({class:'fa fa-caret-down'}),
                    _.span({class:'fa fa-caret-right'})
                );

                $paneItem.append($childrenToggle);

                function onClickChildrenToggle(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    $paneItemContainer.toggleClass('open');
                }

                $childrenToggle.click(onClickChildrenToggle);
            }
        });
        
        if(params.postSort) {
            params.postSort($paneContainer.find('>.pane, .pane-item-container>.children'));
        }

        if(this.$element.find('.tab-panes .pane-container').length &lt; 1) {
            $paneContainer.addClass('active');
            $button.addClass('active');
        }

        this.$element.find('.tab-panes').append($paneContainer);
        this.$element.find('.tab-buttons').append($button);
    }
    
    /**
     * Shows a tab
     *
     * @param {String} tabName
     */
    showTab(tabRoute) {
        onReady('navbar', () => {
            this.$element.find('.tab-panes .pane-container').each(function(i) {
                $(this).toggleClass('active', $(this).attr('data-route') == tabRoute);
            });
            
            this.$element.find('.tab-buttons button').each(function(i) {
                $(this).toggleClass('active', $(this).attr('data-route') == tabRoute);
            });
        });
    }

    /**
     * Reloads this view
     */
    reload() {
        let $currentTab = this.$element.find('.pane-container.active');
        let $currentItem = this.$element.find('.pane-container.active .pane-item-container.active');

        this.fetch();

        if($currentTab.length > 0) {
            let currentTabName = $currentTab.attr('data-route');

            if($currentItem.length > 0) {
                let currentRoute = $currentItem.attr('data-id') || $currentItem.attr('data-routing-path');
            
                this.highlightItem(currentRoute);
            
            } else {
                this.showTab(currentTabName);

            }
        }
    }
    
    /**
     * Highlights an item
     */
    highlightItem(route) {
        let view = this;

        onReady('navbar', () => {
            this.$element.find('.pane-item-container').each(function(i) {
                let $item = $(this);
                let id = ($item.children('a').attr('data-id') || '').toLowerCase();
                let routingPath = ($item.attr('data-routing-path') || '').toLowerCase();

                $item.toggleClass('active', false);
                
                if(
                    id == route.toLowerCase() ||
                    routingPath == route.toLowerCase()
                ) {
                    $item.toggleClass('active', true);

                    $item.parents('.pane-item-container').toggleClass('open', true);

                    view.showTab($item.parents('.pane-container').attr('data-route'));
                }
            });
        });
    }

    clear() {
        this.$element.find('.tab-buttons').empty();
        this.$element.find('.tab-panes').empty();
    }

    render() {
        let view = this;

        resetReady('navbar');

        this.clear();

        // ----------
        // Render main content
        // ----------
        // Get user scopes
        $.ajax({
            type: 'GET',
            url: '/api/user/scopes?token=' + localStorage.getItem('token'),
            success: (allScopes) => {
                let scopes = allScopes[ProjectHelper.currentProject] || [];

                // ----------
                // Render the "about" pane
                // ----------
                this.renderPane({
                    label: 'HashBrown',
                    sublabel: 'v' + app.version,
                    route: '/',
                    $icon: _.img({src: '/svg/logo.svg', class: 'about-logo'}),
                    items: [
                        {
                            name: 'Readme',
                            path: 'readme'
                        },
                        {
                            name: 'License',
                            path: 'license'
                        }
                    ]
                });

                // Render the "content" pane
                this.renderPane(ContentPane.getRenderSettings());
                
                // Render the "media" pane
                this.renderPane(MediaPane.getRenderSettings());
                
                // Render the "forms" pane
                this.renderPane(FormsPane.getRenderSettings());
                
                // Render the "connections" pane
                if(scopes.indexOf('connections') > -1) {
                    this.renderPane(ConnectionPane.getRenderSettings());
                }
                
                // Render the "schemas" pane
                if(scopes.indexOf('schemas') > -1) {
                    this.renderPane(SchemaPane.getRenderSettings());
                }

                // ----------
                // Render the "settings" pane
                // ----------
                if(scopes.indexOf('settings') > -1) {
                    this.renderPane({
                        label: 'Settings',
                        route: '/settings/',
                        icon: 'wrench',
                        items: [
                            {
                                name: 'Languages',
                                path: 'languages'
                            }
                        ]
                    });
                }
                
                // ----------
                // Render the "users" pane
                // ----------
                if(scopes.indexOf('users') > -1) {
                    this.renderPane({
                        label: 'Users',
                        route: '/users/',
                        icon: 'user',
                        items: []
                    });
                }

                triggerReady('navbar');

                $('.cms-container').removeClass('faded');
            },
            error: () => {

            }
        });
    }
}

module.exports = NavbarMain;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ArrayEditor.html">ArrayEditor</a></li><li><a href="BooleanEditor.html">BooleanEditor</a></li><li><a href="Connection.html">Connection</a></li><li><a href="Content.html">Content</a></li><li><a href="ContentReferenceEditor.html">ContentReferenceEditor</a></li><li><a href="ContentSchema.html">ContentSchema</a></li><li><a href="ContentSchemaReferenceEditor.html">ContentSchemaReferenceEditor</a></li><li><a href="DateEditor.html">DateEditor</a></li><li><a href="DropdownEditor.html">DropdownEditor</a></li><li><a href="Entity.html">Entity</a></li><li><a href="FieldSchema.html">FieldSchema</a></li><li><a href="Form.html">Form</a></li><li><a href="FormEditor.html">FormEditor</a></li><li><a href="JSONEditor.html">JSONEditor</a></li><li><a href="LanguageEditor.html">LanguageEditor</a></li><li><a href="LanguageSettings.html">LanguageSettings</a></li><li><a href="Media.html">Media</a></li><li><a href="MediaReferenceEditor.html">MediaReferenceEditor</a></li><li><a href="MessageModal.html">MessageModal</a></li><li><a href="NavbarMain.html">NavbarMain</a></li><li><a href="PeriodEditor.html">PeriodEditor</a></li><li><a href="ProjectHelper.html">ProjectHelper</a></li><li><a href="RichTextEditor.html">RichTextEditor</a></li><li><a href="Schema.html">Schema</a></li><li><a href="SchemaEditor.html">SchemaEditor</a></li><li><a href="SchemaHelper.html">SchemaHelper</a></li><li><a href="StringEditor.html">StringEditor</a></li><li><a href="StructEditor.html">StructEditor</a></li><li><a href="TemplateReferenceEditor.html">TemplateReferenceEditor</a></li><li><a href="UrlEditor.html">UrlEditor</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Aug 29 2016 17:33:28 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
